<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Efficiently Compute KNN with Mahalanobis Distance Â· Rongjia Liu</title><meta name="description" content="Efficiently Compute KNN with Mahalanobis Distance - Rongjia Liu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/arctic.css"><link rel="search" type="application/opensearchdescription+xml" href="http://rliu6.com/atom.xml" title="Rongjia Liu"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><!-- li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") <i class="fa fa-search" aria-hidden="true"></i>--></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Efficiently Compute KNN with Mahalanobis Distance</h1><div class="post-info"><!-- if is_post()--><!--     span &#128197; &nbsp;-->Nov 15, 2020<!-- if is_post()--><!--    span#busuanzi_container_page_pv | &#128065;--><!--    span#busuanzi_value_page_pv--><!--    if item.tags--><!--        span | &nbsp;--><!--        for tag in item.tags.toArray()--><!--            a(href=url_for(tag.path))=  '#' + tag.name--><!-- if item.from && (is_home() || is_post())--><!--    a.post-from(href=item.from target="_blank" title=item.from)!= __('translated')-->
</div><div class="post-content"><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>There are many proximity-based algorithms that can be used to detect potential data outliers. For example, the KNN (K-Nearest Neighbors) is a distance-based algorithm that work well in capturing outliers with extreme values. Specifically, when using the KNN algorithm using the Mahalanobis distance as the distance metric, it tends to capture more meaningful and subtle outliers considering the correlations between features.</p>
<p>More specifically, it is best to apply <strong>Euclidean distance</strong> measurements only if the features are 1) independent and 2) having variances equal to 1. The second condition can usually be satisfied by standardizing while the first condition usually remains an issue.</p>
<p>On the other hand, <strong>Mahalanobis distance</strong> measure first transforms the features into uncorrelated features with variances equal to 1 by dividing the features by their covariance matrix (or practically, multiplying by the inverse of the covariance matrix), then applies Euclidean distance on the transformed feature.</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Given two observations <script type="math/tex">x</script> and <script type="math/tex">y</script>:</p>
<script type="math/tex; mode=display">\text{Mahalanobis Distance}  = \sqrt{(x-y)^T\Sigma^{-1}(x-y)}</script><p>While the KNN with Mahalanobis distance can be carried out in some available modules (i.e. this <a href="https://pyod.readthedocs.io/en/latest/_modules/pyod/models/knn.html" target="_blank" rel="noopener">pyod</a> algorithm), runtime is usually a concern. Because the matrix multiplication by <script type="math/tex">\Sigma^{-1}</script> needs to be computed in each pairwise distance calculation and therefore significantly increase the runtime (imagine doing this with 10 million observations).</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>To address this problem, we can first find the square root matrix <script type="math/tex">A</script> such that <script type="math/tex">A^TA = \Sigma^{-1}</script></p>
<script type="math/tex; mode=display">
\begin{align}
\text{Mahalanobis Distance}  &= \sqrt{(x-y)^T\Sigma^{-1}(x-y)} \\
&= \sqrt{(x-y)^TA^TA(x-y)} \\
&= \sqrt{(Ax-Ay)^T(Ax-Ay)} \\
&= \sqrt{(x'-y')^T(x'-y')} \\
&= \text{Euclidean Distance b/w x' and y'}
\end{align}</script><p>And then basically just run the normal KNN algorithm (with Euclidean distances) on the transformed observation <script type="math/tex">x'</script> and <script type="math/tex">y'</script>, which will be significantly faster as it avoids extensive matrix multiplications:</p>
<script type="math/tex; mode=display">
x' = Ax \\
y' = Ay</script><p>Well you may ask what if there are no real square root matrix <script type="math/tex">A</script>, in which case the tranformed <script type="math/tex">x'</script> and <script type="math/tex">y'</script> will have imaginary parts? Luckily, it seems most of the time we can just use the real part of <script type="math/tex">A</script> to do the transformation and the subsequent Mahalanobis distance calculation, provided that the estimation error (<script type="math/tex">A^TA - \Sigma^{-1}</script>) is small.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/12/finm-notes/05_foreign_exchange/" class="next">NEXT</a></div><div id="container"></div><!-- link(rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css")--><link rel="stylesheet" href="/css/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
    clientID: '4ec287ddd4ac34ff5087',
    clientSecret: 'ae45426765f12ac3e2f903662b8938dc4881f703',
    repo: 'jackliu234.github.io',
    owner: 'jackliu234',
    admin: ['jackliu234'],
    perPage: 100,
    id: 'Sun Nov 15 2020 00:00:00 GMT-0600 GMT'.split('GMT')[0].replace(/\s/g, '-'),
    distractionFreeMode: false,
    pagerDirection: 'first'
})

gitalk.render('container')</script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-133275176-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>