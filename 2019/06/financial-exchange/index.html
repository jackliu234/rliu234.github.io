<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Simluating A Financial Exchange with Socket Server Â· Rongjia Liu</title><meta name="description" content="Simluating A Financial Exchange with Socket Server - Rongjia Liu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/arctic.css"><link rel="search" type="application/opensearchdescription+xml" href="http://jackliu234.com/atom.xml" title="Rongjia Liu"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><!-- li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") <i class="fa fa-search" aria-hidden="true"></i>--></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Simluating A Financial Exchange with Socket Server</h1><div class="post-info">Jun 24, 2019<span id="busuanzi_container_page_pv">| Page Views:</span><span id="busuanzi_value_page_pv"></span><span>| &nbsp;</span><a href="/tags/Tech/" class="post-tags">#Tech</a><!-- if item.from && (is_home() || is_post())--><!--    a.post-from(href=item.from target="_blank" title=item.from)!= __('translated')-->
</div><div class="post-content"><p>On my 20-hour flight back to China, I created a simple financial exchange in python which multiple traders can connect to and place limit order on. This exchange will carry a basic order book, in order to process new orders and keep track of existing orders. The codes are uploaded to this <a href="https://github.com/jackliu234/financial-exchange" target="_blank" rel="noopener">repo</a>.</p>
<a id="more"></a>
<h3 id="Socket-Socket"><a href="#Socket-Socket" class="headerlink" title="Socket.Socket"></a>Socket.Socket</h3><p>The backbone of this exercise is built on the communication between an exchange (server) and a trader (client). The python socket library is used. Here we created a socket instance by passing two parameters: <code>AF_INET</code> refers to the address family <code>ipv4</code>; <code>SOCK_STREAM</code> refers to TCP protocols. We then set the options for this socket: here <code>SO_REUSEADDR</code> tells the kernel to reuse a local socket in TIME_WAIT state before timeout.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>For a server, we want to bind to all interfaces and not just the local host. Therefor we specify an empty string and a randomly chosen port when binding the server.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port = <span class="number">8000</span></span><br><span class="line">server.bind((<span class="string">""</span>, port))</span><br></pre></td></tr></table></figure>
<p>For the client, we need to bind and communicate to the server created above. We create another socket instance also called server in a separte file, and connect to the local host with the same port.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">host = <span class="string">'localhost'</span></span><br><span class="line">port = <span class="number">8000</span></span><br><span class="line">server.connect((host, port))</span><br></pre></td></tr></table></figure>
<h3 id="Select-Select"><a href="#Select-Select" class="headerlink" title="Select.Select"></a>Select.Select</h3><p>We have now created server and client files and need to let them communicate in time. We use the select method from the select library to listen to a list of sockets while filtering out the ones which new activities. We will have infinite loops in both the serve and client files so that we are always listening.</p>
<p>The server will listen to itself (in order to broadcast new trader entrance) and all the clients.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection_list = [server, &lt;potential new clients&gt;]</span><br><span class="line">read_sockets, write_sockets, error_sockets = select.select(</span><br><span class="line">        connection_list, [], [])</span><br><span class="line"><span class="keyword">for</span> socket <span class="keyword">in</span> read_sockets:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>The client will listen to the console input (for user input) and the server (for responses on previous request).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socket_list = [server, sys.stdin]</span><br><span class="line">read_sockets, write_sockets, error_sockets = select.select(</span><br><span class="line">        socket_list, [], [])</span><br><span class="line"><span class="keyword">for</span> socket <span class="keyword">in</span> read_sockets:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h3 id="Code-file-amp-Illustration"><a href="#Code-file-amp-Illustration" class="headerlink" title="Code file &amp; Illustration"></a>Code file &amp; Illustration</h3><p>We now open up the <a href="https://github.com/jackliu234/financial-exchange" target="_blank" rel="noopener">exchange.py</a> and <a href="https://github.com/jackliu234/financial-exchange" target="_blank" rel="noopener">trader.py</a> files in order.</p>
<p>exchange.py:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Liu at RONGJIAs-MacBook <span class="keyword">in</span> ~/Desktop</span><br><span class="line">$ python3 exchange.py</span><br><span class="line">--- exchange initiated ---</span><br></pre></td></tr></table></figure></p>
<p>trader.py:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Liu at RONGJIAs-MacBook <span class="keyword">in</span> ~/Desktop</span><br><span class="line">$ python3 trader.py localhost 8000</span><br><span class="line">--- connected to exchange ---</span><br><span class="line">trader (127.0.0.1:54945) successfully connected to the exchange</span><br><span class="line">instructions:</span><br><span class="line">	enter add_order &lt;price&gt; &lt;quantity&gt; &lt;is_bid&gt; to add <span class="built_in">limit</span> orders</span><br><span class="line">	enter bid_ask to request the current bid-ask spread on the exchange</span><br></pre></td></tr></table></figure></p>
<p>Acting as trader, we added 6 new limit orders and requesting the current bid-ask spread information, which prints the top 3 levels from the bid and ask books.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[127.0.0.1:54945]: add_order 80 100 1</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:80 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: add_order 90 100 1</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:90 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: add_order 100 100 1</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:100 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: add_order 110 100 0</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:110 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: add_order 120 100 0</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:120 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: add_order 130 100 0</span><br><span class="line">[exchange]: trader (127.0.0.1:54945) has successfully added an <span class="built_in">limit</span> order (price:130 quantity:100)</span><br><span class="line">[127.0.0.1:54945]: bid_ask</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"bids"</span>: &#123;</span><br><span class="line">        <span class="string">"100"</span>: 100,</span><br><span class="line">        <span class="string">"90"</span>: 100,</span><br><span class="line">        <span class="string">"80"</span>: 100</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"asks"</span>: &#123;</span><br><span class="line">        <span class="string">"110"</span>: 100,</span><br><span class="line">        <span class="string">"120"</span>: 100,</span><br><span class="line">        <span class="string">"130"</span>: 100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can open up another terminal session and run the trader.py to simulate the entrance of a second trader (do not close the previous sessions). We can check that the bid-ask spread is what we last saw from trader 1.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Liu at RONGJIAs-MacBook <span class="keyword">in</span> ~/Desktop</span><br><span class="line">$ python3 trader.py localhost 8000</span><br><span class="line">--- connected to exchange ---</span><br><span class="line">trader (127.0.0.1:54950) successfully connected to the exchange</span><br><span class="line">instructions:</span><br><span class="line">	enter add_order &lt;price&gt; &lt;quantity&gt; &lt;is_bid&gt; to add <span class="built_in">limit</span> orders</span><br><span class="line">	enter bid_ask to request the current bid-ask spread on the exchange</span><br><span class="line">[127.0.0.1:54950]: bid_ask</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"bids"</span>: &#123;</span><br><span class="line">        <span class="string">"100"</span>: 100,</span><br><span class="line">        <span class="string">"90"</span>: 100,</span><br><span class="line">        <span class="string">"80"</span>: 100</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"asks"</span>: &#123;</span><br><span class="line">        <span class="string">"110"</span>: 100,</span><br><span class="line">        <span class="string">"120"</span>: 100,</span><br><span class="line">        <span class="string">"130"</span>: 100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The second trader then add a bid order with price equals to 110 which is higher or equal to the current lowest ask price. This triggers an order execution on the exchange, and the order book ask quantity at price 100 is reduced by 10.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[127.0.0.1:54950]: add_order 110 10 1</span><br><span class="line">[exchange]: trader (127.0.0.1:54950) has successfully executed an <span class="built_in">limit</span> order (price:110 quantity:10)</span><br><span class="line">[127.0.0.1:54950]: bid_ask</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"bids"</span>: &#123;</span><br><span class="line">        <span class="string">"100"</span>: 100,</span><br><span class="line">        <span class="string">"90"</span>: 100,</span><br><span class="line">        <span class="string">"80"</span>: 100</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"asks"</span>: &#123;</span><br><span class="line">        <span class="string">"110"</span>: 90,</span><br><span class="line">        <span class="string">"120"</span>: 100,</span><br><span class="line">        <span class="string">"130"</span>: 100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Further-Improvements"><a href="#Further-Improvements" class="headerlink" title="Further Improvements"></a>Further Improvements</h3><p>Obviously this is just a starting point towards building a more robust financial exchanges. Many improvements can be made to exchange functionality, orderbook data structure and user interface. Another interesting application would be extending this to create a strategy backtester.</p>
<p>During this project I came across <a href="http://beej.us/guide/bgnet/" target="_blank" rel="noopener">Beejâs Guide to Network Programming</a>, which is a valuable online resource for further studies on network programming. I also found the networking examples in this <a href="https://github.com/dnutiu/python-networking" target="_blank" rel="noopener">repo</a> super helpful.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/fiji/" class="prev">PREV</a><a href="/2019/06/spx-vol-term-struct/" class="next">NEXT</a></div><div id="container"></div><!-- link(rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css")--><link rel="stylesheet" href="/css/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
    clientID: '4ec287ddd4ac34ff5087',
    clientSecret: 'ae45426765f12ac3e2f903662b8938dc4881f703',
    repo: 'jackliu234.github.io',
    owner: 'jackliu234',
    admin: ['jackliu234'],
    perPage: 100,
    id: 'Mon Jun 24 2019 00:00:00 GMT-0500 GMT'.split('GMT')[0].replace(/\s/g, '-'),
    distractionFreeMode: false,
    pagerDirection: 'first'
})

gitalk.render('container')</script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-133275176-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>